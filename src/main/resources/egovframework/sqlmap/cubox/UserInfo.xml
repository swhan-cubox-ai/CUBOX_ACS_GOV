<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="userInfo">

	<sql id="selectUserListColumns">
	<![CDATA[
		select u.fuid
		     , u.funm
		     , u.futype
		     , (select fkind3 from tcommcd where fkind2='COMBO_Futype' and fvalue=u.futype) as futypenm
		     , u.fregdt
		     , u.fmoddt
		     , u.fauthtype
		     , (select fkind3 from tcommcd where fkind2='COMBO_FAuthType' and fvalue=u.fauthtype) as fauthtypenm
		     , u.fpin
		     , u.fauthyn
		     , u.fsidx
		     , u.fgroupid
		     , u.fpartcd1
		     , u.fsstatus
		     , u.fqstatus
		     , u.fpartnm1
		     , u.fpartnm2
		     , u.fpartnm3
		     , DATE_FORMAT(u.fusdt,'%Y-%m-%d') as fusdt
		     , DATE_FORMAT(u.fuedt,'%Y-%m-%d') as fuedt
		     , u.fustatus
		     , (select fvalue from tcommcd where fkind1 = 'combo' and fkind2 = 'COMBO_Fustatus' and fkind3 = u.fustatus) fustatusnm
		     , u.fcarno
		     , c.fcdno as cfcdno
		     , date_FORMAT(c.fsdt,'%Y-%m-%d') as cfsdt
		     , date_FORMAT(c.fedt,'%Y-%m-%d') as cfedt
		     , c.fcdnum as cfcdnum
		     , c.ftype as cftype
		     , c.fstatus as cfstatus
		     , (select fkind3 from tcommcd where fkind2='COMBO_Fcardstatus' and fvalue = c.fstatus) as cfstatusnm
		     , c.fsidx as cfsidx
		     , c.fauthyn as cfauthyn
		     , c.fregdt as cfregdt
		     , c.fmoddt as cfmoddt
		     , c.famodt as cfamodt
		     , c.faupdt as cfaupdt
		     , c.fqstatus as cfqstatus
		     , c.fsstatus as cfsstatus
		     /*, (case when b.fimg is not null and b.fimg != '' then 'Y' else 'N' end) as fbioyn*/
		     , nvl(b.fsstatus, 'N') as fbioyn
		     , nvl(b.fsstatus, 'N') as bfsstatus
		     , IF(date_FORMAT(c.fedt,'%Y-%m-%d') <= date_FORMAT(CURDATE() - INTERVAL 1 DAY,'%Y-%m-%d'),'Y','N') as fexpireyn
		     , nvl(DATEDIFF(CURDATE(), DATE_FORMAT(u.fmoddt ,'%Y-%m-%d')), 0) as fumoddays
		     , u.fissyn
		     , (case when u.fustatus = 'Y' and c.fstatus in ('Y', 'W') then 'Y' else 'N' end) as cf_uc_status
	]]>
	</sql>
	
	<sql id="selectUserListConditions">
		  from tuserinfo_main u
		       inner join tcard_main c on c.fuid = u.fuid
		       left outer join tbio_main b on b.fuid = u.fuid
		 where 1 = 1 
		<if test='@cubox.admin.util.CommonUtils@notEmpty(srchCond)'>
		   and u.fpartcd1 = #{srchCond} 
		</if>
		<if test='@cubox.admin.util.CommonUtils@notEmpty(srchFustatus)'>
		   and u.fustatus = #{srchFustatus}
		</if>
		<if test='@cubox.admin.util.CommonUtils@notEmpty(srchFutype)'>
		   and u.futype = #{srchFutype}
		</if>
		<if test='@cubox.admin.util.CommonUtils@notEmpty(srchAuthType)'>
		   and u.fauthtype = #{srchAuthType}   
		</if>
		<if test='@cubox.admin.util.CommonUtils@notEmpty(srchFcardStatus)'>
		   and c.fstatus = #{srchFcardStatus}
		</if>
		<if test='@cubox.admin.util.CommonUtils@notEmpty(srchCfsdt)'>
		   and c.fsdt <![CDATA[>=]]> #{srchCfsdt}
		</if>
		<if test='@cubox.admin.util.CommonUtils@notEmpty(srchCfedt)'>
		   and c.fedt <![CDATA[<=]]> #{srchCfedt}
		</if>
		<if test='@cubox.admin.util.CommonUtils@notEmpty(srchFexpireyn)'>
		   <!-- and c.fedt > date_format(date_add(curdate(), interval -1 day), '%Y-%m-%d')  /*유효기간만료자*/ -->
		   and c.fstatus = 'Y'
		</if>
		<if test='@cubox.admin.util.CommonUtils@notEmpty(srchFbioyn)'>
		   <!-- and (case when b.fimg is not null and b.fimg != '' then 'Y' else 'N' end) = #{srchFbioyn}  /*사진등록여부*/ -->
		   <if test='srchFbioyn == "Y"'>
		   and b.fsstatus = 'U'
		   </if>
		   <if test='srchFbioyn == "N"'><![CDATA[
		   and (b.fsstatus is null or b.fsstatus <> 'U')
		   ]]></if>
		</if>
		<if test='@cubox.admin.util.CommonUtils@notEmpty(colChkQuery)'>
		   and ${colChkQuery}
		</if>
		<if test='@cubox.admin.util.CommonUtils@notEmpty(colChkQuery2)'>
		   and ${colChkQuery2}
		</if>
	</sql>

	<sql id="selectUserListSort">
		<choose>
			<when test="@cubox.admin.util.CommonUtils@notEmpty(hidSortName)">
				order by ${hidSortName}
				<choose>
					<when test='@cubox.admin.util.CommonUtils@notEmpty(hidSortNum) and hidSortNum != "1"'>desc</when>
					<otherwise>asc</otherwise>
				</choose>
				<!-- , funm asc, fuid asc -->
			</when>
			<otherwise>
				<!-- order by cfedt desc, funm asc, fuid asc  /*출입만료일 기준으로 내림차순*/ -->
				order by fregdt desc
			</otherwise>
		</choose>
	</sql>

	<!-- 출입자관리 조회 -->
	<select id="selectUserList" parameterType="userInfoVO" resultType="userInfoVO">
		<include refid="selectUserListColumns" />
		<include refid="selectUserListConditions" />
		<include refid="selectUserListSort" />
		 limit #{srchCnt} offset #{offset}
	</select>
	
	<!-- 출입자관리 조회  전체건수 -->
	<select id="selectUserListCount" parameterType="userInfoVO" resultType="java.lang.Integer">
		select count(1)
		<include refid="selectUserListConditions" />
	</select>

	<!-- 출입자관리 조회목록 엑셀 저장 -->
	<select id="selectUserListExcel" parameterType="userInfoVO" resultType="excelVO" >
		select a.fuid, ${chkValueArray}
		  from (
		<include refid="selectUserListColumns" />
		<include refid="selectUserListConditions" />
		<if test="@cubox.admin.util.CommonUtils@notEmpty(fuids)">
			and (c.fuid, c.fcdno) in
			<foreach collection="fuids" item="fud" open="(" close=")" separator=",">
				(#{fud.fuid}, #{fud.fcarno})
			</foreach>
		</if>
		) a
		<include refid="selectUserListSort" />
	</select>

    <select id="getUserInfoList3" parameterType="aero.cubox.user.service.vo.UserInfoVO" resultType="aero.cubox.user.service.vo.UserInfoVO" >
		select	u.fuid   	as fuid
			,	u.funm 		as funm
			,	u.futype 	as futype
			,	(select fkind3 from tcommcd where fkind2='COMBO_Futype' and fvalue = u.futype) as futypenm
			,	u.fregdt 	as fregdt
			,	u.fmoddt 	as fmoddt
			,	u.fauthtype as fauthtype
			,	(select fkind3 from tcommcd where fkind2='COMBO_FAuthType' and fvalue = u.fauthtype) as fauthtypenm
			,	u.fpin    	as fpin
			,	u.fauthyn 	as fauthyn
			,	u.fsidx 	as fsidx
			,	u.fgroupid 	as fgroupid
			,	u.fpartnm1 	as fpartnm1
			,	u.fpartnm2 	as fpartnm2
			,	u.fpartnm3 	as fpartnm3
			,	u.fpartcd1 	as fpartcd1
			,	(select fvalue from tcommcd where fkind2='centercd' and fkind3 = u.fpartcd1) as fpartcdnm1
			,	u.fpartcd2 	as fpartcd2
			,	u.fpartcd3 	as fpartcd3
			,	u.fsstatus 	as fsstatus
			,	u.fqstatus 	as fqstatus
			,	u.ftel 		as ftel
			,	u.fcarno 	as fcarno
			,	DATE_FORMAT(u.fusdt,'%Y-%m-%d') 	as fusdt
			,	DATE_FORMAT(u.fuedt,'%Y-%m-%d') 	as fuedt
			,	u.fustatus 	as fustatus
			,	u.fetc1		as fetc1
			,	u.fetc2		as fetc2
			,	u.fvisitnum	as fvisitnum
			,	c.fcdno 	as cfcdno
			,	date_FORMAT(c.fsdt,'%Y-%m-%d')  	as cfsdt
			,	date_FORMAT(c.fedt,'%Y-%m-%d')  	as cfedt
			,	c.fcdnum 	as cfcdnum
			,	c.ftype 	as cftype
			,	c.fstatus 	as cfstatus
			,	(select fkind3 from tcommcd where fkind2='COMBO_Fcardstatus' and fvalue = c.fstatus) as cfstatusnm
			,	c.fsidx   	as cfsidx
			,	c.fauthyn 	as cfauthyn
			,	c.fregdt 	as cfregdt
			,	c.fmoddt 	as cfmoddt
			,	c.famodt 	as cfamodt
			,	c.faupdt 	as cfaupdt
			,	c.fqstatus 	as cfqstatus
			,	c.fsstatus 	as cfsstatus
		  from 	tuserinfo_main u
		  left outer join tcard_main c
		  	on	1=1
		   and	c.fuid = u.fuid
		 where 	(u.fustatus is null or length( u.fustatus) = 0 or u.fustatus = 'Y')
		   and	u.fpartcd1 != '10'
		<if test='srchCond != "10" and srchCond != null'>
		   and	u.fpartcd1 = #{srchCond}
		</if>
		<if test="srchCondWord != '' and srchCondWord != null">
		   and	u.funm like concat('%', #{srchCondWord},'%')
		</if>
		<if test="srchFusdt != '' and srchFusdt != null">
		   and	DATE_FORMAT(u.fusdt,'%Y-%m-%d') >= #{srchFusdt}
		</if>
		<if test="srchFuedt != '' and srchFuedt != null">
		   and	DATE_FORMAT(u.fuedt,'%Y-%m-%d') &lt;= #{srchFuedt}
		</if>
		<if test="srchCfsdt != '' and srchCfsdt != null">
		   and	DATE_FORMAT(c.fsdt,'%Y-%m-%d') >= #{srchCfsdt}
		</if>
		<if test="srchCfedt != '' and srchCfedt != null">
		   and	DATE_FORMAT(c.fedt,'%Y-%m-%d') &lt;= #{srchCfedt}
		</if>
		<if test="srchCardNum != '' and srchCardNum != null">
		   and	c.fcdnum like concat('%', #{srchCardNum},'%')
		</if>
		<if test='srchTemp.equals("Y") and srchVisit == "" '>
		   and	u.fvisitnum like concat('%', #{srchTVCardNum},'%')
		   and	u.futype = '9'
		</if>
		<if test='srchTemp == "" and srchVisit.equals("Y")'>
		   and	u.fvisitnum like concat('%', #{srchTVCardNum},'%')
		   and	u.futype in ('5','6','7','8')
		</if>
		<if test='srchTemp.equals("Y") and srchVisit.equals("Y") '>
		   and	u.fvisitnum like concat('%', #{srchTVCardNum},'%')
		   and	u.futype in ('5','6','7','8','9')
		</if>
		<if test='srchTemp == "" and srchVisit == "" '>
		   and	IFNULL(u.fvisitnum,'') like concat('%', #{srchTVCardNum},'%')
		</if>
		<if test='srchPartnm1.equals("Y") and srchPartnm2 =="" and srchPartnm3 == "" and srchPartnmWord != null'>
			and	u.fpartnm1 like concat('%', #{srchPartnmWord},'%')
		</if>
		<if test='srchPartnm2.equals("Y") and srchPartnm1 =="" and srchPartnm3 == "" and srchPartnmWord != null'>
			and	u.fpartnm2 like concat('%', #{srchPartnmWord},'%')
		</if>
		<if test='srchPartnm3.equals("Y") and srchPartnm1 =="" and srchPartnm2 == "" and srchPartnmWord != null'>
			and	u.fpartnm3 like concat('%', #{srchPartnmWord},'%')
		</if>
		<if test='srchPartnm1.equals("Y") and srchPartnm2.equals("Y") and srchPartnm3 == "" and srchPartnmWord != null'>
			and	(u.fpartnm1 like concat('%', #{srchPartnmWord},'%') or u.fpartnm2 like concat('%', #{srchPartnmWord},'%'))
		</if>
		<if test='srchPartnm1.equals("Y") and srchPartnm2 == "" and srchPartnm3.equals("Y") and srchPartnmWord != null'>
			and	(u.fpartnm1 like concat('%', #{srchPartnmWord},'%') or u.fpartnm3 like concat('%', #{srchPartnmWord},'%'))
		</if>
		<if test='srchPartnm1 == "" and srchPartnm2.equals("Y") and srchPartnm3.equals("Y") and srchPartnmWord != null'>
			and	(u.fpartnm2 like concat('%', #{srchPartnmWord},'%') or u.fpartnm3 like concat('%', #{srchPartnmWord},'%'))
		</if>
		<if test='srchPartnm1.equals("Y") and srchPartnm2.equals("Y") and srchPartnm3.equals("Y") and srchPartnmWord != null'>
			and	(u.fpartnm1 like concat('%', #{srchPartnmWord},'%') or u.fpartnm2 like concat('%', #{srchPartnmWord},'%') or u.fpartnm3 like concat('%', #{srchPartnmWord},'%'))
		</if>
		<if test='srchEfgateuid.equals("Y")'>
			and	e.fgateuid is not null
		</if>
		 order by u.funm asc, u.fuid asc
		 limit	#{srchCnt} offset #{offset}
    </select>

    <select id="getUserTotalCnt3" parameterType="aero.cubox.user.service.vo.UserInfoVO" resultType="int" >
    	select	count(*) as cnt
		  from 	tuserinfo_main u
		  left outer join tcard_main c
		  	on	1=1
		   and	c.fuid = u.fuid
		 where 	(u.fustatus is null or length( u.fustatus) = 0 or u.fustatus = 'Y')
		   and	u.fpartcd1 != '10'
		<if test='srchCond != "10" and srchCond != null'>
		   and	u.fpartcd1 = #{srchCond}
		</if>
		<if test="srchCondWord != '' and srchCondWord != null">
		   and	u.funm like concat('%', #{srchCondWord},'%')
		</if>
		<if test="srchFusdt != '' and srchFusdt != null">
		   and	DATE_FORMAT(u.fusdt,'%Y-%m-%d') >= #{srchFusdt}
		</if>
		<if test="srchFuedt != '' and srchFuedt != null">
		   and	DATE_FORMAT(u.fuedt,'%Y-%m-%d') &lt;= #{srchFuedt}
		</if>
		<if test="srchCfsdt != '' and srchCfsdt != null">
		   and	DATE_FORMAT(c.fsdt,'%Y-%m-%d') >= #{srchCfsdt}
		</if>
		<if test="srchCfedt != '' and srchCfedt != null">
		   and	DATE_FORMAT(c.fedt,'%Y-%m-%d') &lt;= #{srchCfedt}
		</if>
		<if test="srchCardNum != '' and srchCardNum != null">
		   and	c.fcdnum like concat('%', #{srchCardNum},'%')
		</if>
		<if test='srchTemp.equals("Y") and srchVisit == "" '>
		   and	u.fvisitnum like concat('%', #{srchTVCardNum},'%')
		   and	u.futype = '9'
		</if>
		<if test='srchTemp == "" and srchVisit.equals("Y")'>
		   and	u.fvisitnum like concat('%', #{srchTVCardNum},'%')
		   and	u.futype in ('5','6','7','8')
		</if>
		<if test='srchTemp.equals("Y") and srchVisit.equals("Y") '>
		   and	u.fvisitnum like concat('%', #{srchTVCardNum},'%')
		   and	u.futype in ('5','6','7','8','9')
		</if>
		<if test='srchTemp == "" and srchVisit == "" '>
		   and	IFNULL(u.fvisitnum,'') like concat('%', #{srchTVCardNum},'%')
		</if>
		<if test='srchPartnm1.equals("Y") and srchPartnm2 =="" and srchPartnm3 == "" and srchPartnmWord != null'>
			and	u.fpartnm1 like concat('%', #{srchPartnmWord},'%')
		</if>
		<if test='srchPartnm2.equals("Y") and srchPartnm1 =="" and srchPartnm3 == "" and srchPartnmWord != null'>
			and	u.fpartnm2 like concat('%', #{srchPartnmWord},'%')
		</if>
		<if test='srchPartnm3.equals("Y") and srchPartnm1 =="" and srchPartnm2 == "" and srchPartnmWord != null'>
			and	u.fpartnm3 like concat('%', #{srchPartnmWord},'%')
		</if>
		<if test='srchPartnm1.equals("Y") and srchPartnm2.equals("Y") and srchPartnm3 == "" and srchPartnmWord != null'>
			and	(u.fpartnm1 like concat('%', #{srchPartnmWord},'%') or u.fpartnm2 like concat('%', #{srchPartnmWord},'%'))
		</if>
		<if test='srchPartnm1.equals("Y") and srchPartnm2 == "" and srchPartnm3.equals("Y") and srchPartnmWord != null'>
			and	(u.fpartnm1 like concat('%', #{srchPartnmWord},'%') or u.fpartnm3 like concat('%', #{srchPartnmWord},'%'))
		</if>
		<if test='srchPartnm1 == "" and srchPartnm2.equals("Y") and srchPartnm3.equals("Y") and srchPartnmWord != null'>
			and	(u.fpartnm2 like concat('%', #{srchPartnmWord},'%') or u.fpartnm3 like concat('%', #{srchPartnmWord},'%'))
		</if>
		<if test='srchPartnm1.equals("Y") and srchPartnm2.equals("Y") and srchPartnm3.equals("Y") and srchPartnmWord != null'>
			and	(u.fpartnm1 like concat('%', #{srchPartnmWord},'%') or u.fpartnm2 like concat('%', #{srchPartnmWord},'%') or u.fpartnm3 like concat('%', #{srchPartnmWord},'%'))
		</if>
		<if test='srchEfgateuid.equals("Y")'>
			and	e.fgateuid is not null
		</if>
    </select>

 	<select id="getUserInfo" parameterType="String" resultType="aero.cubox.user.service.vo.UserInfoVO" >
		select	fuid  /*[UserInfo.getUserInfo]*/
			,	funm
			,	futype
			,	fregdt
			,	fmoddt
			,	fauthtype
			,	fpin
			,	fauthyn
			,	fsidx
			,	fgroupid
			,	fpartnm1
			,	fpartnm2
			,	fpartnm3
			,	ftel
			,	fcarno
			,	fpartcd1
			,	fpartcd2
			,	fpartcd3
			,	fvisitnum
			,	fsstatus
			,	fqstatus
			,	fusdt
			,	fuedt
			,	fetc1
			,	fetc2
			,	DATE_FORMAT(fusdt,'%Y-%m-%d') as fusdt2
			,	DATE_FORMAT(fuedt,'%Y-%m-%d') as fuedt2
			,	fustatus
		  from 	tuserinfo_main u
		 where 	(fustatus is null or fustatus = 'Y' or length(fustatus) = 0)
		   and	fuid = #{fuid}
    </select>

    <select id="getUserInfo2" parameterType="aero.cubox.user.service.vo.UserInfoVO" resultType="aero.cubox.user.service.vo.UserInfoVO" >
		select	fuid
			,	funm
			,	futype
			,	fregdt
			,	fmoddt
			,	fauthtype
			,	fpin
			,	fauthyn
			,	fsidx
			,	fgroupid
			,	fpartnm1
			,	fpartnm2
			,	fpartnm3
			,	ftel
			,	fcarno
			,	fpartcd1
			,	fpartcd2
			,	fpartcd3
			,	fvisitnum
			,	fsstatus
			,	fqstatus
			,	fusdt
			,	fuedt
			,	fetc1
			,	fetc2
			,	DATE_FORMAT(fusdt,'%Y-%m-%d') as fusdt2
			,	DATE_FORMAT(fuedt,'%Y-%m-%d') as fuedt2
			,	fustatus
			,	hp_no as hpNo
			,	fissyn
			,	ifnull((select case when b.fimg is not null and b.fimg != '' then 'Y' else 'N' end from tbio_main b where b.fdt = 'T' and b.fuid = u.fuid ), 'N') as fbioyn
		  from 	tuserinfo_main u
		 where 	fuid = #{fuid}
		   and	fpartcd1 = #{fpartcd1}
    </select>

    <select id="getUserBioInfo" parameterType="String" resultType="aero.cubox.user.service.vo.UserBioInfoVO" >
    	select	fdt, fuid, fimg, fextdata, fquality, fregdt, fmoddt
    		, 	ffailcnt, fsidx, fextfg, fsstatus, fqstatus, factdt, fqstdt
    		, 	fwvname, fwedt, fwsdt
    	  from	tbio_main
		 where 	fdt = 'T'
		   and	fuid = #{fuid}

    </select>

    <select id="getCardInfoList" parameterType="String" resultType="aero.cubox.sample.service.vo.CardInfoVO" >
		select	fcdno
			,	DATE_FORMAT(fsdt,'%Y-%m-%d') as fsdt
			,	DATE_FORMAT(fedt,'%Y-%m-%d') as fedt
			,	fuid
			,	ftype
			,	fstatus
			,	fsidx
			,	fregdt
			,	fmoddt
			,	factdt
			,	fauthyn
			,	fsstatus
			,	fqstatus
			,	famodt
			,	faupdt
			,	fqstdt
			,	fwvname
			,	fwedt
			,	fwsdt
		  from 	tcard_main
		 where 	1=1
		   and	fuid = #{fuid}
    </select>

    <select id="getUserAuthGroupList11" parameterType="aero.cubox.auth.service.vo.AuthGroupVO" resultType="aero.cubox.auth.service.vo.AuthGroupVO" >
    	select	tu.fuid
			,	tu.ftid
			,	tu.fcdno
			,	tu.fuseyn
			,  	tu.fsstatus
			,	tu.fregdt
			,	tu.fqstatus
			,	(select fitemnm from tlocationtree where ftid = tu.ftid) as fitemnm
  		  from 	tuserauthgroup_11 tu
 		 where 	tu.fuid = #{fuid}
   		   and 	tu.fcdno = #{fcdno}
		 order by tu.ftid asc
    </select>

    <select id="getUserAuthGroupList12" parameterType="aero.cubox.auth.service.vo.AuthGroupVO" resultType="aero.cubox.auth.service.vo.AuthGroupVO" >
    	select	tu.fuid
			,	tu.ftid
			,	tu.fcdno
			,	tu.fuseyn
			,  	tu.fsstatus
			,	tu.fregdt
			,	tu.fqstatus
			,	(select fitemnm from tlocationtree where ftid = tu.ftid) as fitemnm
  		  from 	tuserauthgroup_12 tu
 		 where 	tu.fuid = #{fuid}
   		   and 	tu.fcdno = #{fcdno}
		 order by tu.ftid asc
    </select>

    <select id="getTotalAuthGroupList11" parameterType="aero.cubox.auth.service.vo.AuthGroupVO" resultType="aero.cubox.auth.service.vo.AuthGroupVO" >
    	select	ftid, fitemnm
		  from	tlocationtree
		 where	fptid = '112'
		   and	(ftid, fitemnm) not in ( select	tu.ftid
											,	(select fitemnm from tlocationtree where ftid = tu.ftid) as fitemnm
										  from	tuserauthgroup_11 tu
										 where	tu.fuid = #{fuid}
										   and	tu.fcdno = #{fcdno}
										)
		<if test="srchCondWord != '' and srchCondWord != null">
		   and	fitemnm like concat('%', #{srchCondWord},'%')
		</if>
		 order by ftid asc, fitemnm asc
    </select>

    <select id="getTotalAuthGroupList12" parameterType="aero.cubox.auth.service.vo.AuthGroupVO" resultType="aero.cubox.auth.service.vo.AuthGroupVO" >
    	select	ftid, fitemnm
		  from	tlocationtree
		 where	fptid = '122'
		   and	(ftid, fitemnm) not in ( select	tu.ftid
											,	(select fitemnm from tlocationtree where ftid = tu.ftid) as fitemnm
										  from	tuserauthgroup_12 tu
										 where	tu.fuid = #{fuid}
										   and	tu.fcdno = #{fcdno}
										)
		<if test="srchCondWord != '' and srchCondWord != null">
		   and	fitemnm like concat('%', #{srchCondWord},'%')
		</if>
		 order by ftid asc, fitemnm asc
    </select>

    <select id="getCardInfo" parameterType="aero.cubox.sample.service.vo.CardInfoVO" resultType="aero.cubox.sample.service.vo.CardInfoVO" >
    	select	a.fcdno, a.ftype, a.fstatus, a.fcdnum
			,	DATE_FORMAT(a.fsdt,'%Y-%m-%d') as fsdt
			,	DATE_FORMAT(a.fedt,'%Y-%m-%d') as fedt
			,	case when (b.fustatus is null or length(b.fustatus) = 0 or b.fustatus = 'Y') and a.fstatus in ('Y', 'W') then 'Y' else 'N' end as fworkgb
		  from 	tcard_main a
		  	,	tuserinfo_main b
		 where 	a.fuid = b.fuid
		   and	a.fcdno = #{fcdno}
		   and	b.fpartcd1 = #{fpartcd1}
		   and	b.fuid = #{fuid}
    </select>

    <update id="cardInfoSave" parameterType="aero.cubox.sample.service.vo.CardInfoVO" >
    	update	tcard_main
    	   set	fstatus = #{fstatus}
    	   	,	fcdnum = #{fcdnum}
    	   	,	fsdt = #{fsdt}
    	   	,	fedt = #{fedt}
    	   	,	fsstatus = #{fsstatus}
    	   	,	fmoddt = NOW(3)
    	 where 	fcdno = #{fcdno}
    	   and	fuid = #{fuid}
    </update>

    <select id="getCdnoCnt" parameterType="aero.cubox.sample.service.vo.CardInfoVO" resultType="Integer" >
    	select	count(*) as cnt
		  from 	tcard_main cm
		  	,	tuserinfo_main um
		 where	cm.fuid = um.fuid
		   and	um.fpartcd1 = #{fpartcd1}
		   and 	cm.fcdno = #{fcdno}
    </select>

    <insert id="addUserCdno" parameterType="aero.cubox.sample.service.vo.CardInfoVO" >
    	insert	into	tcard_main
    					(
    						fcdno, fsdt, fedt, fuid, fstatus, fsidx, fsstatus, fqstatus, fcdnum, fregdt
    					)
    			values	(
    						#{fcdno}, #{fsdt}, #{fedt}, #{fuid}, nvl(#{fstatus}, 'Y'), #{fsidx}, 'I', 'I', #{fcdnum}, now(3)
    					)
    </insert>

    <update id="userFsstatusChange" parameterType="aero.cubox.user.service.vo.UserInfoVO" >
    	update	tuserinfo_main
    	   set	fsstatus = #{fsstatus}
    	 where 	fuid = #{fuid}
    </update>    

    <update id="tauthtogateMainFsstatusChange" parameterType="aero.cubox.sample.service.vo.CardInfoVO" >
    	update	tauthtogate_main_${fpartcd1}
    	   set	fsstatus = #{fsstatus}
    	 where 	fuid = #{fuid}
    	   and	fcdno = #{fcdno}
    </update>

    <update id="userInfoSave" parameterType="aero.cubox.user.service.vo.UserInfoVO" >
    	update	tuserinfo_main
    	   set	fmoddt = now(3)
    	   	,	fauthtype = #{fauthtype}
    	   	,	fsstatus = #{fsstatus}
    	   	,   futype = #{futype}
    	   	,   fvisitnum = #{fvisitnum}
    	   	,	funm = #{funm}
    	   	,   fpartnm2 = #{fpartnm2}
    	   	,	fmodid = #{fmodid} 
    	 where 	fuid = #{fuid}
    	   and	fpartcd1 = #{fpartcd1}
    </update>
    
    <update id="userInfoSaveSync" parameterType="aero.cubox.user.service.vo.UserInfoVO" >
    	update	tuserinfo_main
    	   set	fmoddt = now(3)
    	   	,	fsstatus = 'Q'
    	 where 	fuid = #{fuid}
    	   and	fpartcd1 = #{fpartcd1}
    </update>    
    
	<update id="updateUserInfo" parameterType="aero.cubox.user.service.vo.UserInfoVO" >
	<![CDATA[
		update tuserinfo_main
		   set funm = #{funm}
		     , futype = #{futype}
		     , fvisitnum = #{fvisitnum}		     
		     , fauthtype = #{fauthtype}
		     , fpartnm1 = #{fpartnm1}
		     , fpartnm2 = #{fpartnm2}
		     , fpartnm3 = #{fpartnm3}
		     , fcarno =  #{fcarno}
		     , ftel = #{ftel}
		     , hp_no = #{hpNo}
		     , fetc1 = #{fetc1}
		     , fetc2 = #{fetc2}
		     , fmoddt = now(3)
		     , fmodid = #{fmodid}
		 where fuid = #{fuid}
		   and fpartcd1 = #{fpartcd1}
	]]>
	</update>

    <update id="userInfoPhoneUpdate" parameterType="aero.cubox.user.service.vo.UserInfoVO" >
    	update	tuserinfo_main
    	   set	fpartcd2 = #{fpartcd2}
    	   	,	ftel = #{ftel}
    	   	,	fmobilefg = #{fmobilefg}
    	   	,	fsstatus = #{fsstatus}
    	   	,	fmoddt = now(3)
    	 where 	1=1
    	   and	fuid = #{fuid}
    	   and	fpartcd1 = #{fpartcd1}
    </update>

    <update id="userInfoCarnoUpdate" parameterType="aero.cubox.user.service.vo.UserInfoVO" >
    	update	tuserinfo_main
    	   set	fpartcd3 = #{fpartcd3}
    	   	,	fcarno = #{fcarno}
    	   	,	fmoddt = now(3)
    	 where 	1=1
    	   and	fuid = #{fuid}
    	   and	fpartcd1 = #{fpartcd1}
    </update>

    <update id="userInfoCarnoCmlUpdate" >
    	update	tcmlinfo
    	   set	factdt = ''
    	 where 	1=1
    	   and	fvname = 'nirscar11'
    </update>

    <update id="userInfoEtcUpdate" parameterType="aero.cubox.user.service.vo.UserInfoVO" >
    	update	tuserinfo_main
    	   set	fetc1 = #{fetc1}
    	   	,	fetc2 = #{fetc2}
    	   	,	fmoddt = now(3)
    	 where 	1=1
    	   and	fuid = #{fuid}
    	   and	fpartcd1 = #{fpartcd1}
    </update>

    <select id="getAuthGroupFtid" parameterType="String" resultType="String" >
    	select	ftid
		  from 	tlocationtree
		 where 	fitemnm = #{fitemnm}
    </select>
    
	<select id="selectNewFuid" resultType="java.lang.String">
		select lpad(nextval(sfuid), 8, '0')
	</select>

    <insert id="newUserInfoSave" parameterType="aero.cubox.user.service.vo.UserInfoVO" >
    	insert	into	tuserinfo_main
    					(
    						fuid, funm, fregdt, fauthtype, fsidx, fgroupid, fpartnm1, fpartnm2, fpartnm3, fcarno, fpartcd1, fpartcd2, fpartcd3, fsstatus, fusdt, fuedt,
    						futype, ftel, hp_no, fvisitnum, fmobilefg, fetc1, fetc2, fauthyn, fregid
    					)
    			values	(
    						#{fuid}, #{funm}, now(3), #{fauthtype}, #{fsidx}, #{fgroupid}, #{fpartnm1}, #{fpartnm2}, #{fpartnm3}, #{fcarno}, #{fpartcd1}, #{fpartcd2}, #{fpartcd3}, 'U', #{fusdt}, #{fuedt},
    						#{futype}, #{ftel}, #{hpNo}, #{fvisitnum}, #{fmobilefg}, #{fetc1}, #{fetc2}, 'Y', #{fregid}

    					)
    </insert>
    
	<!-- 사용자 권한 그룹  -->
    <insert id="insertUserAuthGroup" parameterType="aero.cubox.auth.service.vo.AuthorGroupVO">
		insert into user_author_group_tb (fuid, fpartcd1 , author_group_id , regist_dt , regist_id)
		select #{fuid}, #{siteId}, author_group_id , now(3), #{registId}
		  from author_group_tb
		 where use_yn = 'Y'
		   and author_group_id in <foreach collection="groupArray" item="item" index="index" separator="," open="(" close=")">#{item}</foreach>
    </insert>    
    
    <!-- 사용자 권한 그룹 (정직원인 경우) -->
    <insert id="insertUserAuthGroupForNewEmp" parameterType="aero.cubox.auth.service.vo.AuthorGroupVO">
		insert into user_author_group_tb (fuid, fpartcd1 , author_group_id , regist_dt , regist_id)
		select #{fuid}, #{siteId}, author_group_id , now(3), #{registId}
		  from author_group_tb
		 where use_yn = 'Y'
		   and emp_yn = 'Y'
    </insert>     

	<select id="getFuidFunmCnt" parameterType="aero.cubox.user.service.vo.UserInfoVO" resultType="Integer" >
    	select	count(*) as cnt
		  from 	tuserinfo_main
		 where	fuid = #{fuid}
    </select>

    <update id="excelUserInfoUpdate" parameterType="aero.cubox.user.service.vo.UserInfoVO" >
    	update	tuserinfo_main
    	   set	funm = #{funm}
    	   	,	fmoddt = now(3)
    	   	,	fgroupid = #{fgroupid}
    	   	,	fusdt = #{fusdt}
    	   	,	fuedt = #{fuedt}
    	 where 	1=1
    	   and	fuid = #{fuid}
    </update>

    <update id="excelCardInfoUpdate" parameterType="aero.cubox.sample.service.vo.CardInfoVO" >
    	update	tcard_main
    	   set	fcdnum = #{fcdnum}
    	   	,	fsdt = #{fsdt}
    	   	,	fedt = #{fedt}
    	   	,	fmoddt = NOW(3)
    	 where 	fcdno = #{fcdno}
    	   and	fuid = #{fuid}
    </update>

    <update id="imgUserInfoUpload" parameterType="aero.cubox.user.service.vo.UserBioInfoVO" >
    	update	tbio_main
    	   set	fimg = #{fimg}
    	   	,	fmoddt = now(3)
    	   	,	fsstatus = 'Q'
    	   	, 	fsidx = #{fsidx}
    	 where 	fuid = #{fuid}
    </update>

    <insert id="imgUserInfoSave" parameterType="aero.cubox.user.service.vo.UserBioInfoVO" >
    	insert	into	tbio_main
    					(
    						fdt, fuid, fimg, fregdt, fsidx, fsstatus, fqstatus
    					)
    			values	(
    						"T", #{fuid}, #{fimg}, now(3), #{fsidx}, 'Q', 'U'
    					)
    </insert>

    <select id="getBioCnt" parameterType="String" resultType="Integer" >
    	select	count(*) as cnt
		  from 	tbio_main
		 where	fuid = #{fuid}
		   and	fdt = 'T'
    </select>

    <select id="getBioLinkCnt" parameterType="String" resultType="Integer" >
    	select	count(*) as cnt
		  from 	tbiolink
		 where	fuid = #{fuid}
		   and	fdt = 'T'
    </select>


    <select id="getOtherCenterUserInfoList11" parameterType="String" resultType="aero.cubox.user.service.vo.UserInfoVO" >
    	select	u.fuid, u.funm, u.futype, c.fcdno as cfcdno, u.fauthtype
			,	(select fkind3 from tcommcd where fkind2='COMBO_FAuthType' and fvalue = u.fauthtype) as fauthtypenm
			, 	IFNULL(u.fpartnm1,'') as fpartnm1
			, 	IFNULL(u.fpartnm2,'') as fpartnm2
			, 	IFNULL(u.fpartnm3,'') as fpartnm3
			, 	IFNULL(u.fpartcd2,'') as fpartcd2
			, 	IFNULL(u.ftel,'') as ftel
			,	IFNULL(u.fetc1,'') as fetc1
			,	IFNULL(u.fetc2,'') as fetc2
			, 	u.fpartcd1
			,	(select fvalue from tcommcd where fkind2='centercd' and fkind3 = u.fpartcd1) as fpartcdnm1
		  from 	tuserinfo_main u
		  left 	outer join tcard_main c
			on	(c.fstatus is null or length( c.fstatus) = 0 or c.fstatus = 'Y')
		   and	c.fuid = u.fuid
		 where 	u.futype in ('1','2')
		   and 	u.fpartcd1 = '12'
		   and	c.fcdno is not null
		   and	( u.funm, c.fcdno) not in (
											select	u.funm, c.fcdno
											  from 	tuserinfo_main u
											  left 	outer join tcard_main c
												on	(c.fstatus is null or length( c.fstatus) = 0 or c.fstatus = 'Y')
											   and	c.fuid = u.fuid
											 where 	1=1
											   and 	fpartcd1 = '11'
											)
		   and	u.funm = #{srchFunmWord}
    </select>

    <select id="getOtherCenterUserInfoList12" parameterType="String" resultType="aero.cubox.user.service.vo.UserInfoVO" >
    	select	u.fuid, u.funm, u.futype, c.fcdno as cfcdno, u.fauthtype
			,	(select fkind3 from tcommcd where fkind2='COMBO_FAuthType' and fvalue = u.fauthtype) as fauthtypenm
			, 	IFNULL(u.fpartnm1,'') as fpartnm1
			, 	IFNULL(u.fpartnm2,'') as fpartnm2
			, 	IFNULL(u.fpartnm3,'') as fpartnm3
			, 	IFNULL(u.fpartcd2,'') as fpartcd2
			, 	IFNULL(u.ftel,'') as ftel
			,	IFNULL(u.fetc1,'') as fetc1
			,	IFNULL(u.fetc2,'') as fetc2
			, 	u.fpartcd1
			,	(select fvalue from tcommcd where fkind2='centercd' and fkind3 = u.fpartcd1) as fpartcdnm1
		  from 	tuserinfo_main u
		  left 	outer join tcard_main c
			on	(c.fstatus is null or length( c.fstatus) = 0 or c.fstatus = 'Y')
		   and	c.fuid = u.fuid
		 where 	u.futype in ('1','2')
		   and 	u.fpartcd1 = '11'
		   and	c.fcdno is not null
		   and	( u.funm, c.fcdno) not in (
											select	u.funm, c.fcdno
											  from 	tuserinfo_main u
											  left 	outer join tcard_main c
												on	(c.fstatus is null or length( c.fstatus) = 0 or c.fstatus = 'Y')
											   and	c.fuid = u.fuid
											 where 	1=1
											   and 	fpartcd1 = '12'
											)
		   and	u.funm = #{srchFunmWord}
    </select>

    <select id="getUsrListConnTotalCnt" parameterType="aero.cubox.user.service.vo.UserInfoVO" resultType="int">
    	select
    		count(1) as cnt
    	from tuserinfo_main a
    		left outer join tcard_main c on c.fuid = a.fuid
    	where a.futype in ('1','4')
			and a.fuid not in ( select t.fuid from tsiteuser t where t.fuid is not null )
    	<if test="@cubox.admin.util.CommonUtils@notEmpty(fuid)">
			and a.fuid like concat('%',#{fuid},'%')
		</if>
		<if test="@cubox.admin.util.CommonUtils@notEmpty(funm)">
			and a.funm like concat('%',#{funm},'%')
		</if>
		<if test="@cubox.admin.util.CommonUtils@notEmpty(fcdno)">
			and c.fcdno like concat('%',#{fcdno},'%')
		</if>
    </select>

    <select id="getUsrListConnPop" parameterType="aero.cubox.user.service.vo.UserInfoVO" resultType="aero.cubox.user.service.vo.UserInfoVO">
    	select
    		a.fuid,
    		a.funm,
    		a.fpartnm1,
    		a.fpartnm2,
    		a.fpartnm3,
    		c.fcdno as cfcdno
    	from tuserinfo_main a
    		left outer join tcard_main c on c.fuid = a.fuid
    	where a.futype in ('1','4')
    	  and a.fuid not in ( select t.fuid from tsiteuser t where t.fuid is not null )
    	<if test="@cubox.admin.util.CommonUtils@notEmpty(fuid)">
			and a.fuid like concat('%',#{fuid},'%')
		</if>
		<if test="@cubox.admin.util.CommonUtils@notEmpty(funm)">
			and a.funm like concat('%',#{funm},'%')
		</if>
		<if test="@cubox.admin.util.CommonUtils@notEmpty(fcdno)">
			and c.fcdno like concat('%',#{fcdno},'%')
		</if>
		order by a.fregdt
		limit #{srchCnt} offset #{offset}
    </select>

    <insert id="imgUserInfoLinkUpload" parameterType="aero.cubox.user.service.vo.UserBioInfoVO">
    	update	tbiolink
    	   set	fimg = #{fimg}
    	   	,	fmoddt = now(3)
    	   	,	ffailcnt = 0
    	   	,	fsstatus = 'Q'
    	   	, 	frcvflg = COALESCE(#{frcvflg},'S')
    	 where  fuid = #{fuid}
    </insert>


    <update id="imgUserInfoLinkSave" parameterType="aero.cubox.user.service.vo.UserBioInfoVO">
    	insert	into tbiolink
				(
					fdt, fuid, fimg, fregdt, fsstatus, ffailcnt, frcvflg
				)
		values	(
					"T", #{fuid}, #{fimg}, now(3), 'Q', 0, COALESCE(#{frcvflg},'S')
				)
    </update>

    <update id="cardInfoUpdate" parameterType="aero.cubox.user.service.vo.UserInfoVO">
    	update	tcard_main
    	   set	fstatus = #{cfstatus}
    	   	 ,	fsdt = #{fusdt2}
    	   	 ,	fedt = #{fuedt2}
    	   	 ,	fsstatus = #{fsstatus}
    	   	 ,	fmoddt = NOW(3)
    	   	 , 	fcdno = #{newFcdno}
    	 where 	fcdno = #{cfcdno}
    	   and	fuid = #{fuid}
    </update>
    
    <update id="updateCardInfo" parameterType="aero.cubox.sample.service.vo.CardInfoVO">
    	update tcard_main
    	   set fmoddt = now(3)
    	     , fsdt = #{fsdt}
    	     , fedt = #{fedt}
    	     , fstatus = #{fstatus}
    	     , fsstatus = #{fsstatus}
		<if test="@cubox.admin.util.CommonUtils@notEmpty(fnewcdno)">
		     , fcdno = #{fnewcdno}
		</if>
		 where fcdno = #{fcdno}
		   and fuid = #{fuid}
    </update>

    <update id="chkCardInfoLstUpdate" parameterType="aero.cubox.user.service.vo.UserInfoVO">
    	update tcard_main
    	   set fstatus = #{cfstatus}
    	   	 , fsdt = #{fusdt2}
    	   	 , fedt = #{fuedt2}
    	   	 , fsstatus = #{fsstatus}
    	   	 , fmoddt = NOW(3)
    	 where (fuid, fcdno) in
    	 <foreach collection="fuids" item="fud" open="(" close=")" separator=",">
    	 	(#{fud.fuid}, #{fud.cfcdno})
    	 </foreach>
    </update>

    <update id="chkUserInfoLstSave" parameterType="aero.cubox.user.service.vo.UserInfoVO">
    	update	tuserinfo_main
    	   set	fmoddt = now(3)
    	   	,	fauthtype = #{fauthtype}
    	   	,	fsstatus = #{fsstatus}
    	 where  fpartcd1 = #{fpartcd1}
    	 and 	(fuid, fpartcd1) in
    	 <foreach collection="fuids" item="fud" open="(" close=")" separator=",">
    	 	(#{fud.fuid}, #{fud.fpartcd1})
    	 </foreach>
    </update>

    <update id="allCardInfoLstUpdate" parameterType="aero.cubox.user.service.vo.UserInfoVO">
    	update	tcard_main
    	   set	fstatus = #{cfstatus}
    	   	,	fsdt = #{fusdt2}
    	   	,	fedt = #{fuedt2}
    	   	,	fsstatus = #{fsstatus}
    	   	,	fmoddt = NOW(3)
    </update>

    <update id="allUserInfoLstSave" parameterType="aero.cubox.user.service.vo.UserInfoVO">
    	update	tuserinfo_main
    	   set	fmoddt = now(3)
    	   	,	fauthtype = #{fauthtype}
    	   	,	fsstatus = #{fsstatus}
    	 where  fpartcd1 = #{fpartcd1}
    </update>

    <insert id="setDownLoadResnLog" parameterType="java.util.HashMap">
    	<selectKey resultType="int" keyProperty="fdwnidx" order="BEFORE">
    		select COALESCE(max(fdwnidx),0)+1 from tdwnresnlog where fip = #{fip}
    	</selectKey>
    	insert into tdwnresnlog
    	(fip, fdwnidx, fregdt, fdwnflg, fresn)
    	values
    	(
    		#{fip},
    		#{fdwnidx},
    		now(3),
    		#{fdwnflg},
    		#{fresn}
    	)
    </insert>

    <select id="getDownloadLogCnt" parameterType="aero.cubox.user.service.vo.UserInfoVO" resultType="int">
    	select count(*)
    	from tdwnresnlog
    </select>

    <select id="selectDownloadLogList" parameterType="aero.cubox.user.service.vo.UserInfoVO" resultType="aero.cubox.sample.service.vo.DownloadLogVO">
    	select
    		fip,
    		fdwnidx,
    		fregdt,
    		fdwnflg,
    		fresn
    	from tdwnresnlog
    	order by fregdt desc
    	limit #{srchCnt} offset #{offset}
    </select>

    <update id="updateBioExpire" parameterType="HashMap">
		update tbio_main set
		fimg = '',
		fextdata = '',
		fsstatus = 'Q',
		<if test='@cubox.admin.util.CommonUtils@notEmpty(fsidx)'>
			fsidx = #{fsidx},
		</if>
		fmoddt = now(3)
		where fuid = #{fuid}
		and length(fimg) > 0
    </update>

    <update id="updateBiolinkExpire" parameterType="HashMap">
		update tbiolink set
		fimg = '',
		fsstatus = 'Q',
		ffailcnt= 0,
		fmoddt = now(3)
		where fuid = #{fuid}
		and length(fimg) > 0
    </update>

    <update id="updateCardExpire" parameterType="HashMap">
		update tcard_main set
		fstatus = 'E',
		fmoddt = now(3)
		where fcdno = #{fcdno}
    </update>

    <update id="updateUserExpire" parameterType="HashMap">
		update tuserinfo_main set
		fsstatus = 'Q',
		fmoddt = now(3)
		where fuid = #{fuid}
    </update>
    
    <update id="updateCardNotUsed" parameterType="HashMap">
		update tcard_main 
		   set fstatus = 'D'
		     , fmoddt = now(3)
		 where fuid = (select fuid from tuserinfo_main where fuid = #{fuid} and fpartcd1 = #{fpartcd1})
    </update>    
    
    <update id="updateUserNotUsed" parameterType="HashMap">
		update tuserinfo_main 
		   set fustatus = 'D'
		     , fsstatus = 'Q'
		     , fmoddt = now(3)
		     , fmodid = #{fmodid}
		 where fuid = #{fuid}
		   and fpartcd1 = #{fpartcd1}
    </update>
    
    <update id="updateUserForDrop" parameterType="HashMap">
		update tuserinfo_main 
		   set fustatus = 'D'
		     , fsstatus = 'Q'
		     , fmoddt = now(3)
		     , fmodid = #{fmodid}
		 where fuid = #{fuid}
		   and fpartcd1 = #{fpartcd1}
    </update>    
    
    <update id="updateCardReco" parameterType="HashMap">
		update tcard_main 
		   set fstatus = 'Y'
		     , fmoddt = now(3)
		 where fuid = (select fuid from tuserinfo_main where fuid = #{fuid} and fpartcd1 = #{fpartcd1})
    </update>    
    
    <update id="updateUserReco" parameterType="HashMap">
		update tuserinfo_main 
		   set fustatus = 'Y'
		     , fsstatus = 'Q'
		     , fmoddt = now(3)
		     , fmodid = #{fmodid}
		 where fuid = #{fuid}
		   and fpartcd1 = #{fpartcd1}
    </update>    

    <select id="selectChkFuid" parameterType="aero.cubox.user.service.vo.UserInfoVO" resultType="int" >
    	select count(1)
    	from tuserinfo_main a
    	where a.fuid = #{fuid}
    </select>
    
    <select id="selectChkFvisitnum" parameterType="java.util.HashMap" resultType="int">
    	select count(1)
    	  from tuserinfo_main
    	 where fustatus = 'Y'
    	   and futype = '3' /* 방문객카드 */
    	   and cast(fvisitnum as unsigned) = cast(#{fvisitnum} as unsigned)
		<if test='workgb == "M"'><![CDATA[
    	   and fuid <> #{fuid}
		]]></if>    	   
    </select>
	
	<!-- 카드 중복 체크 -->
	<select id="selectChkFcdno" parameterType="aero.cubox.sample.service.vo.CardInfoVO" resultType="HashMap">
		SELECT 
			IFNULL(
				GROUP_CONCAT( DISTINCT (SELECT CONCAT(funm, '(', fuid, ')') FROM tuserinfo_main WHERE fuid = card.fuid order by fuid ASC) SEPARATOR ', ' )
				, ''
			) AS funm
			, COUNT(*) AS cnt
		FROM
			tcard_main AS card
		<where>
			card.fcdno = #{fcdno}
		</where>
	</select>
	
	<select id="selectUserStatus" parameterType="HashMap" resultType="HashMap">
		select a.fpartcd1, a.fuid, a.funm, a.fustatus, a.futype, c.fkind3 as futypenm
		     , b.fcdno, b.fstatus as cfstatus, d.fkind3 as cfstatusnm
		     , b.fsdt , b.fedt, a.fissyn
		     , case when a.fustatus = 'Y' and b.fstatus in ('Y', 'W') then 'Y' else 'N' end as cf_uc_status
		  from tuserinfo_main a
		       inner join tcard_main b on b.fuid = a.fuid
		       inner join tcommcd c on c.fkind1 = 'combo' and c.fkind2 = 'COMBO_Futype' and c.fvalue = a.futype
		       inner join tcommcd d on d.fkind1 = 'combo' and d.fkind2 = 'COMBO_Fcardstatus' and d.fvalue = b.fstatus
		 where a.fuid = #{fuid}
		   and a.fpartcd1 = #{fpartcd1}
		   and b.fcdno = #{fcdno}
	</select>
	
	<sql id="selectUserListByAuthColumns"><![CDATA[
		select a.author_group_id, a.author_group_nm, a.sort_ordr 
		     , c.funm, c.fpartnm1, c.fpartnm2, c.fpartnm3, c.hp_no, c.ftel, c.futype 
		     , (select fkind3 from tcommcd t where fkind1 = 'combo' and fkind2 = 'COMBO_Futype' and fvalue = c.futype ) futypenm
		     , d.fcdno
		     , d.fstatus as cfstatus
		     , (select fkind3 from tcommcd t where fkind1 = 'combo' and fkind2 = 'COMBO_Fcardstatus' and fvalue = d.fstatus ) card_status
		     , d.fsdt
		     , d.fedt	
		     , c.fuid	
	]]></sql>
	<sql id="selectUserListByAuthCondition">
		  from author_group_tb a
		       inner join user_author_group_tb b on b.author_group_id = a.author_group_id
		       inner join tuserinfo_main c on c.fuid = b.fuid and c.fpartcd1 = b.fpartcd1
		       inner join tcard_main d on d.fuid = c.fuid
		 where 1 = 1
		<if test="@cubox.admin.util.CommonUtils@notEmpty(arrAuthGroupCd)">
		   and a.author_group_id in <foreach collection="arrAuthGroupCd" item="item" index="index" separator="," open="(" close=")">#{item}</foreach>
		</if>
		<if test="@cubox.admin.util.CommonUtils@notEmpty(srchNm)">
		   and c.funm like concat('%', #{srchNm}, '%') 
		</if>
		<if test="@cubox.admin.util.CommonUtils@notEmpty(srchFutype)">
		   and c.futype = #{srchFutype}
		</if>
		<if test="@cubox.admin.util.CommonUtils@notEmpty(srchCdNo)">
		   and d.fcdno like concat('%', #{srchCdNo}, '%')
		</if>
		<if test="@cubox.admin.util.CommonUtils@notEmpty(srchFpartnm1) and @cubox.admin.util.CommonUtils@notEmpty(srchPartWord)">
		   and c.fpartnm1 like concat('%', #{srchPartWord}, '%')
		</if>
		<if test="@cubox.admin.util.CommonUtils@notEmpty(srchFpartnm2) and @cubox.admin.util.CommonUtils@notEmpty(srchPartWord)">
		   and c.fpartnm2 like concat('%', #{srchPartWord}, '%')
		</if>	
		<if test="@cubox.admin.util.CommonUtils@notEmpty(srchFpartnm3) and @cubox.admin.util.CommonUtils@notEmpty(srchPartWord)">
		   and c.fpartnm3 like concat('%', #{srchPartWord}, '%')
		</if>			
		<if test="@cubox.admin.util.CommonUtils@notEmpty(arrCardStatus) and @cubox.admin.util.CommonUtils@empty(fsNone)">
		   and d.fstatus in <foreach collection="arrCardStatus" item="item" index="index" separator="," open="(" close=")">#{item}</foreach>
		</if>	
		<if test="@cubox.admin.util.CommonUtils@empty(arrCardStatus) and @cubox.admin.util.CommonUtils@notEmpty(fsNone)">
		   and (d.fstatus is null or length(d.fstatus) = 0)		
		</if>
		<if test="@cubox.admin.util.CommonUtils@notEmpty(arrCardStatus) and @cubox.admin.util.CommonUtils@notEmpty(fsNone)">
 		   and (   d.fstatus in <foreach collection="arrCardStatus" item="item" index="index" separator="," open="(" close=")">#{item}</foreach>
 		        or d.fstatus is null or length(d.fstatus) = 0)
		</if>
	</sql>
	
	<select id="selectUserListByAuthCount" parameterType="java.util.HashMap" resultType="java.lang.Integer">
		select count(1)
		<include refid="selectUserListByAuthCondition" />
	</select>
	
	<select id="selectUserListByAuth" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		<include refid="selectUserListByAuthColumns" />
		<include refid="selectUserListByAuthCondition" />
		 order by a.sort_ordr, c.funm, c.fuid, d.fcdno		
		 limit #{srchCnt} offset #{offset}
	</select>
	
	<select id="selectUserListByAuthExcel" parameterType="java.util.HashMap" resultType="aero.cubox.sample.service.vo.ExcelVO">
		select ${chkValueArray} 
		  from (
		<include refid="selectUserListByAuthColumns" />
		<include refid="selectUserListByAuthCondition" />
			   ) t
		 order by t.sort_ordr, t.funm, t.fuid, t.fcdno	  
	</select>
	
	<sql id="selectUserListByGateColumns"><![CDATA[
		select b.device_id as fgid
		     , b.device_no as fvname
		     , b.device_nm as flname	
		     , a.device_no
		     , a.fuid
		     , c.fpartcd1 
		     , a.create_dt 
		     , a.update_dt 
		     , a.status
		     , a.cud_type 
		     , c.funm, c.fpartnm1, c.fpartnm2, c.fpartnm3, c.hp_no, c.ftel, c.futype
		     , (select fkind3 from tcommcd t where fkind1 = 'combo' and fkind2 = 'COMBO_Futype' and fvalue = c.futype ) futypenm
		     , d.fcdno
		     , d.fstatus as cfstatus
		     , (select fkind3 from tcommcd t where fkind1 = 'combo' and fkind2 = 'COMBO_Fcardstatus' and fvalue = d.fstatus ) card_status
		     , d.fsdt
		     , d.fedt 
	]]></sql>
	<sql id="selectUserListByGateCondition">
		  from sync_device a
		       inner join device_info_tb b on b.device_no = a.DEVICE_NO 
		       inner join tuserinfo_main c on c.fuid = a.fuid
		       inner join tcard_main d on d.fuid = c.fuid
		 where a.cud_type = 'C'
		<if test="@cubox.admin.util.CommonUtils@notEmpty(arrGateId)">
		   and b.device_id in <foreach collection="arrGateId" item="item" index="index" separator="," open="(" close=")">#{item}</foreach>
		</if>
		<if test="@cubox.admin.util.CommonUtils@notEmpty(srchNm)">
		   and c.funm like concat('%', #{srchNm}, '%') 
		</if>
		<if test="@cubox.admin.util.CommonUtils@notEmpty(srchFutype)">
		   and c.futype = #{srchFutype}		
		</if>
		<if test="@cubox.admin.util.CommonUtils@notEmpty(srchCdNo)">
		   and d.fcdno like concat('%', #{srchCdNo}, '%')
		</if>		
		<if test="@cubox.admin.util.CommonUtils@notEmpty(srchFromDt)">
		   and d.fsdt >= #{srchFromDt}
		</if>	
		<if test="@cubox.admin.util.CommonUtils@notEmpty(srchToDt)">
		   and d.fedt &lt;= #{srchToDt}
		</if>			
		<if test="@cubox.admin.util.CommonUtils@notEmpty(srchFpartnm1) and @cubox.admin.util.CommonUtils@notEmpty(srchPartWord)">
		   and c.fpartnm1 like concat('%', #{srchPartWord}, '%')
		</if>
		<if test="@cubox.admin.util.CommonUtils@notEmpty(srchFpartnm2) and @cubox.admin.util.CommonUtils@notEmpty(srchPartWord)">
		   and c.fpartnm2 like concat('%', #{srchPartWord}, '%')
		</if>	
		<if test="@cubox.admin.util.CommonUtils@notEmpty(srchFpartnm3) and @cubox.admin.util.CommonUtils@notEmpty(srchPartWord)">
		   and c.fpartnm3 like concat('%', #{srchPartWord}, '%')
		</if>			
		<if test="@cubox.admin.util.CommonUtils@notEmpty(arrCardStatus) and @cubox.admin.util.CommonUtils@empty(fsNone)">
		   and d.fstatus in <foreach collection="arrCardStatus" item="item" index="index" separator="," open="(" close=")">#{item}</foreach>
		</if>	
		<if test="@cubox.admin.util.CommonUtils@empty(arrCardStatus) and @cubox.admin.util.CommonUtils@notEmpty(fsNone)">
		   and (d.fstatus is null or length(d.fstatus) = 0)		
		</if>
		<if test="@cubox.admin.util.CommonUtils@notEmpty(arrCardStatus) and @cubox.admin.util.CommonUtils@notEmpty(fsNone)">
 		   and (   d.fstatus in <foreach collection="arrCardStatus" item="item" index="index" separator="," open="(" close=")">#{item}</foreach>
 		        or d.fstatus is null or length(d.fstatus) = 0)
		</if>
	</sql>

	<select id="selectUserListByGateCount" parameterType="java.util.HashMap" resultType="java.lang.Integer">
		select count(1)
		<include refid="selectUserListByGateCondition" />
	</select>

	<select id="selectUserListByGate" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		<include refid="selectUserListByGateColumns" />
		<include refid="selectUserListByGateCondition" />
		 order by b.device_id, c.funm, c.fuid, d.fcdno		
		 limit #{srchCnt} offset #{offset}
	</select>
	
	<select id="selectUserListByGateExcel" parameterType="java.util.HashMap" resultType="aero.cubox.sample.service.vo.ExcelVO">
		select ${chkValueArray} 
		  from (
		<include refid="selectUserListByGateColumns" />
		<include refid="selectUserListByGateCondition" />
			   ) t
		 order by fgid, funm, fuid, fcdno
	</select>
	
	<!-- 2021-04-05 출입자 영구삭제 -->
	<delete id="deleteBiolinkInfo" parameterType="java.util.HashMap">
		delete from tbiolink 
		 where fuid = #{fuid}
	</delete>
	
	<delete id="deleteBioInfo" parameterType="java.util.HashMap">
		delete from tbio_main 
		 where fuid = #{fuid}
	</delete>
	
	<delete id="deleteCardInfo" parameterType="java.util.HashMap">
		delete from tcard_main
		 where fuid = #{fuid}
		   and (select count(1) from tgatelog where fuid = #{fuid}) = 0
	</delete>
	
	<delete id="deleteUserInfo" parameterType="java.util.HashMap">
		delete from tuserinfo_main
		 where fuid = #{fuid} 
		   and fpartcd1 = #{fpartcd1}
	</delete>
	
	<!-- 외부에서 출입자 등록, 출입자 엑셀업로드 저장 -->
	<insert id="insertUserRest" parameterType="java.util.HashMap">
		insert into tuserinfo_main 
		(fuid, funm, futype, fauthtype, fauthyn, fustatus, fsstatus, fsidx, fusdt, fuedt, fpartnm1, fpartnm2, fpartcd1 , fregid, fregdt)
		values 
		(#{fuid}, #{funm}, '1', 'CF', 'Y', 'Y', 'Q', '0', #{fsdt}, #{fedt}, #{fpartnm1}, #{fpartnm2}, #{siteId}, #{registId}, substring(date_format(current_timestamp(3), '%Y-%m-%d %H:%i:%s.%f'), 1, 23));
	</insert>
	<insert id="insertCardRest" parameterType="java.util.HashMap">		
		insert into tcard_main
		(fcdno, fsdt, fedt, fuid, fstatus, fsidx,  fsstatus, fqstatus, fregdt)
		values
		(#{fuid}, #{fsdt}, #{fedt}, #{fuid}, 'Y', '0', 'I', 'I', substring(date_format(current_timestamp(3), '%Y-%m-%d %H:%i:%s.%f'), 1, 23));
	</insert>
	<insert id="insertAuthRest" parameterType="java.util.HashMap">		
		insert into user_author_group_tb (fuid, fpartcd1 , author_group_id , regist_dt , regist_id)
		select #{fuid}, #{siteId}, author_group_id , now(3), #{registId}
		  from author_group_tb
		 where use_yn = 'Y'
		   and emp_yn = 'Y';
	</insert>
	<insert id="insertSyncDeviceRest" parameterType="java.util.HashMap">	
		insert into sync_device (device_no, fuid, create_dt, update_dt, status, cud_type)
		select d.device_no, u.fuid, current_timestamp(), current_timestamp(), 'Q', 'C'  
		  from user_author_group_tb u
		       inner join author_group_detail_tb g on g.author_group_id = u.author_group_id 
		       inner join device_info_tb d on d.device_id = g.fgid and d.site_id = #{siteId}
		 where u.fuid = #{fuid}
		   and u.fpartcd1 = #{siteId};
	</insert>		
	<insert id="insertFaceRest" parameterType="java.util.HashMap">
		insert into tbio_main (fdt, fuid, fimg, fregdt, fextfg, fsstatus, fqstatus)
		values ('T', #{fuid}, #{fimg}, current_date(), '0', 'Q', 'U');
	</insert>
	<insert id="insertFaceSyncRest" parameterType="java.util.HashMap">	
		insert into tbiolink (fdt, fuid, fimg, fregdt, ffailcnt, fsstatus, frcvflg)
		values ('T', #{fuid}, #{fimg}, current_date(), '0', 'Q', 'S');
	</insert>
	<insert id="insertLogRest" parameterType="java.util.HashMap">	
		insert into tsyslog (fevttm, fsiteid, fsyscode, fdetail, fcnntip)
		values (current_timestamp(), #{registId}, #{syslogCode}, concat(#{fuid},'_',#{funm}), #{fcnntip})
	</insert>	
</mapper>